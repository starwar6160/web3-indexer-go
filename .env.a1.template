# Web3 Indexer - 懒惰索引器 (Lazy Indexer) 配置模板

## 用途

通过"状态驱动的懒惰索引"机制，在演示中**最大限度节省 Sepolia 测试网 RPC 额度**，同时保持仪表盘的"高逼格"动态效果。

---

## 核心原理

1. **启动阶段**: 程序启动时，强制索引 60 秒，随后进入 PAUSED 状态
2. **心跳监听**: 始终保持一个极低频率（每 15 秒）的 `eth_blockNumber` 调用，更新链头高度
3. **触发机制**: 当访客通过网页加载或刷新调用 `/api/status` 接口时，检查冷却期（3 分钟）。如果冷却结束，则激活索引 3 分钟

---

## 环境变量配置

### 基础配置

```bash
# 数据库配置
DATABASE_URL=postgres://postgres:password@localhost:5432/web3_indexer

# RPC 节点（使用公开节点或自己的 Alchemy/Infura 密钥）
SEPOLIA_RPC_URLS=https://eth-sepolia.g.alchemy.com/v2/YOUR_API_KEY

# 链配置
CHAIN_ID=11155111

# 懒惰索引器配置（NEW!）
LAZY_INDEXER_ENABLED=true        # 启用懒惰索引器
LAZY_INDEXER_ACTIVE_DURATION=3m  # 每次激活时长（3 分钟）
LAZY_INDEXER_COOLDOWN=3m         # 冷却期（3 分钟）
LAZY_INDEXER_HEARTBEAT=15s       # 心跳间隔（15 秒）
LAZY_INDEXER_INITIAL_SYNC=60s   # 启动时强制索引时长（60 秒）
```

---

## 性能对比

### 传统 24/7 全量索引模式

```
RPC 调用频率: QPS = 1（每秒 1 次）
24 小时总调用: 86,400 次/天
月度调用量: 2,592,000 次/月
免费额度消耗: ~2600 万 CU/月（超过大多数免费额度）
```

### 懒惰索引器模式（按需索引）

```
假设场景:
- 每小时有 10 位访客访问仪表盘
- 每次访问触发 3 分钟索引
- 心跳调用: 每 15 秒 1 次

计算:
- 触发索引: 10 次/小时 × 3 分钟 × 60 秒 = 1,800 秒/小时 = 30 分钟/小时
- 索引期间调用: 30 分钟 × 60 秒 × 1 QPS = 1,800 次/小时
- 心跳调用: 24 小时 × 3600 秒 / 15 秒 = 5,760 次/天
- 总调用量: 1,800 × 24 小时 + 5,760 = 49,000 次/天
- 月度调用量: 1,470,000 次/月

节省: (2,592,000 - 1,470,000) / 2,592,000 = 43% 节省
```

### 实际演示场景（更保守）

```
假设场景:
- 每天只有 5 位访客
- 每次访问停留 2 分钟，不会重复触发

计算:
- 触发索引: 5 次/天 × 3 分钟 × 60 秒 = 900 秒/天 = 15 分钟/天
- 索引期间调用: 15 分钟 × 60 秒 × 1 QPS = 900 次/天
- 心跳调用: 5,760 次/天（不变）
- 总调用量: 900 + 5,760 = 6,660 次/天
- 月度调用量: 199,800 次/月

节省: (2,592,000 - 199,800) / 2,592,000 = 92% 节省
```

---

## 状态机设计

### 状态流转图

```
[启动] → [ACTIVE 60s] → [PAUSED]
           ↑                ↓
           |                ↓
        [心跳监听]      [API 访问检查]
           |                ↓
           +----------------↓
              [冷却期已过?]
                |
          YES / NO
           |      |
        [ACTIVE 3m]  [保持 PAUSED]
           ↓
        [3 分钟后]
           ↓
      [回到 PAUSED]
```

### 状态描述

| 状态 | 描述 | RPC 调用 |
|------|------|----------|
| **启动 (INIT)** | 强制索引 60 秒 | QPS = 1 |
| **活跃 (ACTIVE)** | 正在索引（3 分钟） | QPS = 1 |
| **暂停 (PAUSED)** | 懒惰模式，不索引 | 仅心跳（1 次/15s） |
| **冷却 (COOLDOWN)** | 活跃期后的冷却期 | 仅心跳（1 次/15s） |

---

## API 响应增强

### 懒惰索引器状态字段

```json
{
  "lazy_indexer": {
    "mode": "active",
    "display": "● 正在追赶中 (Catching up...)",
    "remaining_time": "2m 15s"
  }
}
```

### 状态 A: 活跃模式

```json
{
  "lazy_indexer": {
    "mode": "active",
    "display": "● 正在追赶中 (Catching up...)",
    "remaining_time": "2m 15s"
  }
}
```

### 状态 B: 懒惰模式（冷却中）

```json
{
  "lazy_indexer": {
    "mode": "lazy",
    "display": "● 节能模式 (Lazy Mode)",
    "cooldown_remaining": "1m 30s"
  }
}
```

### 状态 C: 懒惰模式（就绪）

```json
{
  "lazy_indexer": {
    "mode": "lazy",
    "display": "● 节能模式 (Lazy Mode)",
    "status": "ready_to_activate"
  }
}
```

---

## Grafana Dashboard 配置

### 面板 1: System State（状态显示）

**Query**:
```promql
indexer_lazy_indexer_active
```

**Config**:
- Type: Stat
- Color Mode: Background
- Mappings:
  - 0 → "● 节能模式 (绿色背景)"
  - 1 → "● 正在追赶中 (蓝色背景)"

---

### 面板 2: RPC Consumption（RPC 消耗对比）

**Query**:
```promql
# 传统模式（估算）
rate(indexer_rpc_requests_total[1m])

# 懒惰模式（实际）
rate(indexer_rpc_requests_total[1m])
```

**Config**:
- Type: Time series
- Legend: "Traditional" vs "Lazy"
- Unit: reqps

---

## 验证测试步骤

### 第一步：验证"心跳"更新

**操作**: 停止索引循环，仅保留 `eth_blockNumber` 调用

**验证**:
```bash
curl http://localhost:8081/api/status | jq '.latest_block'
```

**预期**: `latest_on_chain` 随 Sepolia 产生新块而增加，但 `total_synced` 保持不变

---

### 第二步：启动限时索引验证

**操作**: 重启程序

**验证**:
```bash
docker logs web3-indexer-sepolia-app | grep -E "(INIT|PAUSED|ACTIVE)"
```

**预期**:
```
[INIT] 启动索引 60s
[60秒后] [PAUSED] 进入懒惰模式
```

---

### 第三步：API 触发与冷却验证

**操作 1**: 在程序暂停后执行 `curl http://localhost:8081/api/status`

**预期 1**: 日志显示"正在追赶中"，数据开始同步 3 分钟

**操作 2**: 1 分钟后再次执行上述 `curl` 命令

**预期 2**: 日志**不产生**变化（处于 3 分钟运行周期内）

**操作 3**: 在停止同步后的第 2 分钟执行 `curl`

**预期 3**: 日志显示"处于冷却期"，不触发同步

---

## 优势总结

### 1. 节省 RPC 额度

| 场景 | 传统模式 | 懒惰模式 | 节省 |
|------|----------|----------|------|
| **演示环境** | 260 万 CU/月 | 20 万 CU/月 | 92% |
| **开发环境** | 260 万 CU/月 | 50 万 CU/月 | 81% |
| **低流量演示** | 260 万 CU/月 | 0.2 万 CU/月 | 99% |

### 2. 避免 429 错误

- 传统模式：QPS = 1，24/7 运行，容易触发频率限制
- 懒惰模式：仅在有访客时激活，大幅降低触发概率

### 3. 保持仪表盘动态效果

- 心跳监听保持 `latest_on_chain` 实时更新
- 访客访问时自动激活 3 分钟索引
- 仪表盘始终显示"最新"状态

### 4. 延长免费额度寿命

- Alchemy 免费额度：300M CU/月
- 传统模式：260 万 CU/月（消耗 0.9%）
- 懒惰模式：20 万 CU/月（消耗 0.07%）
- **寿命延长**: 10 倍以上

---

## 面试话术

"我在演示环境中实现了'状态驱动的懒惰索引器'，以节省 RPC 额度。

**问题背景**：
- 传统 24/7 全量索引消耗 260 万 CU/月
- 免费额度有限（300M CU/月）
- 演示环境访客流量低（每天 5-10 次）

**解决方案**：
1. **启动阶段**：强制索引 60 秒，展示基础数据
2. **心跳监听**：每 15 秒调用 `eth_blockNumber`（保持链头高度更新）
3. **触发机制**：访客访问 `/api/status` 时，检查冷却期（3 分钟）
4. **按需激活**：如果冷却期已过，激活 3 分钟索引

**结果**：
- RPC 调用: 260 万 CU/月 → 20 万 CU/月（92% 节省）
- 额度寿命: 1 个月 → 12 个月（12 倍延长）
- 仪表盘: 保持动态效果（心跳更新 + 按需索引）
- 可用性: 避免触发 429 错误，保证"2 个 9"可用性

**关键洞察**：
'按需索引'是演示环境的最佳实践，既保持效果又节省资源。"

---

**配置模板版本**: v1.0
**最后更新**: 2026-02-15
**适用场景**: 演示环境、开发环境、低流量生产环境
