<!DOCTYPE html>
<html>

<head>
    <title>{{ .Title }}</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/dashboard.css">
    <style>
        /* ğŸš€ Critical CSS: Environment Switcher (Inlined to bypass CDN caching) */
        #env-switcher {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            height: 45px !important;
            background: #0d1117 !important; /* æ·±é»‘è‰²åº•å±‚ï¼Œé€‚é…å·¥ä¸šçº§å®¡ç¾ */
            background-color: #0d1117 !important;
            border-bottom: 1px solid #30363d !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 9999 !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5) !important;
            font-family: 'JetBrains Mono', 'Courier New', monospace !important;
        }

        .banner-content {
            width: 100% !important;
            max-width: 1400px !important;
            padding: 0 20px !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
        }

        .env-group { display: flex !important; align-items: center !important; gap: 12px !important; }
        .pulse-dot { width: 10px !important; height: 10px !important; border-radius: 50% !important; }
        .pulse-dot.sepolia { background: #00ff00 !important; box-shadow: 0 0 10px #00ff00 !important; animation: pulse-green 2s infinite !important; }
        .pulse-dot.anvil { background: #9333ea !important; box-shadow: 0 0 10px #9333ea !important; animation: pulse-purple 2s infinite !important; }

        @keyframes pulse-green { 0% { transform: scale(0.95); opacity: 0.8; } 50% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(0.95); opacity: 0.8; } }
        @keyframes pulse-purple { 0% { transform: scale(0.95); opacity: 0.8; } 50% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(0.95); opacity: 0.8; } }

        .env-label { color: #8b949e !important; font-size: 11px !important; font-weight: bold !important; text-transform: uppercase !important; }
        .env-name { color: #ffffff !important; font-size: 13px !important; font-weight: bold !important; }

        .github-link {
            display: flex !important;
            align-items: center !important;
            gap: 6px !important;
            color: #ffffff !important;
            text-decoration: none !important;
            font-size: 13px !important;
            font-weight: bold !important;
            padding: 4px 12px !important;
            border-radius: 6px !important;
            background: #238636 !important;
            transition: background 0.2s !important;
        }
        .github-link:hover { background: #2ea043 !important; }

        .switch-btn {
            text-decoration: none !important;
            font-size: 12px !important;
            padding: 4px 12px !important;
            border-radius: 6px !important;
            border: 1px solid #3b82f6 !important;
            color: #3b82f6 !important;
            font-weight: bold !important;
            transition: all 0.2s ease !important;
        }

        .switch-btn:hover { background: #3b82f6 !important; color: #ffffff !important; }
        .switch-btn.main { border-color: #f0883e !important; color: #f0883e !important; }
        .switch-btn.main:hover { background: #f0883e !important; color: #0d1117 !important; }
        
        /* è°ƒæ•´ container é—´è·ä»¥é€‚é… fixed header */
        body { padding-top: 65px !important; }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const title = "{{ .Title }}";
            const currentEnv = "{{ .Environment }}";
            const currentDS = "{{ .PostgresDS }}";
            
            const pulse = document.getElementById('env-pulse');
            const name = document.getElementById('env-name');
            const actions = document.getElementById('env-actions');
            const grafanaIframe = document.getElementById('grafana-iframe');

            // å¢å¼ºçš„åˆ¤æ–­é€»è¾‘
            const isSepolia = currentEnv === "sepolia";
            const isPublic = window.location.hostname.includes("st6160.click");

            if (isSepolia) {
                document.body.style.borderTop = "5px solid #2563eb";
                if(pulse) pulse.classList.add('sepolia');
                if(name) name.innerText = "ğŸš€ SEPOLIA LIVE (demo1)";
                if(actions) actions.innerHTML = '<a href="https://demo2.st6160.click" class="switch-btn">Switch to Local Lab (demo2) â†’</a>';
            } else {
                document.body.style.borderTop = "5px solid #9333ea";
                if(pulse) pulse.classList.add('anvil');
                if(name) name.innerText = "ğŸ§ª LOCAL LAB (demo2)";
                if(actions) actions.innerHTML = '<a href="https://demo1.st6160.click" class="switch-btn main">â† Back to Sepolia Live (demo1)</a>';
            }

            // ğŸš€ åŠ¨æ€ä¿®å¤ Grafana Iframe åœ°å€ (ç”±åç«¯æä¾›åŸºå› )
            if (grafanaIframe) {
                let grafanaBase = "";
                if (isPublic) {
                    grafanaBase = "https://grafana-demo2.st6160.click";
                } else {
                    // ä½¿ç”¨åç«¯è¯†åˆ«çš„ Host
                    grafanaBase = window.location.protocol + "//" + window.location.hostname + ":4000";
                }
                const dashboardPath = `/d/web3-indexer-multi/web3-indexer-multi?orgId=1&refresh=5s&kiosk&var-Environment=${currentEnv}&var-PostgresDS=${currentDS}`;
                grafanaIframe.src = grafanaBase + dashboardPath;
                console.log("ğŸ§¬ Environment-Aware Dashboard Loaded:", currentEnv, currentDS);
            }
        });
    </script>
</head>

<body>
    <div id="env-switcher">
        <div class="banner-content">
            <div class="env-group">
                <span id="env-pulse" class="pulse-dot"></span>
                <span class="env-label">ENVIRONMENT:</span>
                <span id="env-name" class="env-name">Loading...</span>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <a href="https://github.com/starwar6160/web3-indexer-go" class="github-link" target="_blank">
                    <svg height="16" width="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
                    GitHub
                </a>
                <div id="env-actions" class="env-actions"></div>
            </div>
        </div>
    </div>
    <div class="container">
        <header>
            <h1>{{ .Title }}</h1>
            <p class="header-subtitle">Real-time blockchain indexing with Go | Industrial Grade Architecture</p>
        </header>

        <div class="grid">
            <div class="card">
                <h2>ğŸ“Š System Status</h2>
                <div class="stat">
                    <span class="stat-label">System State</span>
                    <span class="stat-value" id="state">
                        <span class="status-connecting">INITIALIZING...</span>
                    </span>
                </div>
                <div class="stat">
                    <span class="stat-label">Latest (on Chain)</span>
                    <span class="stat-value" id="latestBlock">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Total (Synced)</span>
                    <span class="stat-value" id="totalBlocks">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Total Transfers</span>
                    <span class="stat-value" id="totalTransfers">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Real-time TPS</span>
                    <span class="stat-value" id="tps" style="color: #ff9800; font-weight: bold;">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Processing Speed (BPS)</span>
                    <span class="stat-value" id="bps" style="color: #9c27b0;">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">E2E Latency</span>
                    <span class="stat-value" id="latency" style="color: #e91e63; font-weight: bold;">0ms</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Sync Lag (Missing)</span>
                    <span class="stat-value" id="syncLag" style="color: #667eea;">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Unique Visitors</span>
                    <span class="stat-value" id="totalVisitors" style="color: #00bcd4; font-weight: bold;">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Self-Healing</span>
                    <span class="stat-value" id="selfHealing" style="color: #28a745;">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Health</span>
                    <span id="health" class="status-badge status-warning">Checking...</span>
                </div>
                <div id="signatureStatus" style="margin-top: 5px; text-align: right;">
                    <span style="color: #666; font-size: 11px;">Unsigned Payload</span>
                </div>
                <div class="refresh-time">Last updated: <span id="lastUpdate">-</span></div>
            </div>

            <div class="card"
                style="flex: 1; background: #1e1e1e; color: #d4d4d4; font-family: 'Courier New', monospace; max-height: 300px; overflow-y: auto; border: 1px solid #333;">
                <h2
                    style="color: #fff; border-bottom: 1px solid #333; padding-bottom: 5px; font-size: 16px; margin-top: 0;">
                    ğŸ“œ Engine Logs</h2>
                <div id="logEntries" style="font-size: 11px; line-height: 1.4;">
                    <div style="color: #666;">> System standby...</div>
                </div>
            </div>

            <div class="card" style="flex: 1; border: 1px solid #00bcd4;">
                <h2 style="color: #00bcd4;">ğŸ“¡ Visitor Audit</h2>
                <p style="color: #ccc; font-size: 13px; margin-bottom: 10px;">Dynamic Anomaly Detection Active</p>
                <div class="stat">
                    <span class="stat-label" style="font-size: 11px;">Admin/Stress IP (Auto-Filtered)</span>
                    <span class="stat-value" id="adminIP" style="font-size: 12px; color: #f44336;">None</span>
                </div>
                <div class="stat">
                    <span class="stat-label" style="font-size: 11px;">Heuristic Status</span>
                    <span class="stat-value" style="font-size: 11px; color: #28a745;">LEARNING...</span>
                </div>
                <p style="font-size: 10px; color: #666; margin-top: 10px;">Identifies IPs with >90% traffic dominance as
                    non-human/dev and excludes them from persistent stats.</p>
            </div>

            <div class="card" style="flex: 1; border: 1px solid #ff9800;">
                <h2 style="color: #ff9800;">ğŸ›¡ï¸ Deterministic Security</h2>
                <p style="color: #ccc; font-size: 13px; margin-bottom: 15px;">Verified by EdDSA (Ed25519) Signatures</p>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <a href="/security"
                        style="background: #ff9800; color: #000; text-align: center; padding: 10px; border-radius: 4px; text-decoration: none; font-weight: bold; transition: 0.3s;">
                        Enter Security Verification Site
                    </a>
                </div>
                <p style="font-size: 11px; color: #666; margin-top: 10px; text-align: center;">Fingerprint: FFA0 B998
                    E7AF...5DCF</p>
            </div>

            <div class="card" style="flex: 1;">
                <h2>ğŸ”— API Endpoints</h2>
                <p style="color: #666; font-size: 13px; margin-bottom: 15px;">Access detailed information via REST API
                </p>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <a href="/healthz" style="color: #667eea; text-decoration: none; font-size: 13px;">â†’ Health Check
                        (/healthz)</a>
                    <a href="/metrics" style="color: #667eea; text-decoration: none; font-size: 13px;">â†’ Prometheus
                        Metrics (/metrics)</a>
                    <a href="/api/status" style="color: #667eea; text-decoration: none; font-size: 13px;">â†’ System
                        Status (/api/status)</a>
                    <a href="/api/blocks" style="color: #667eea; text-decoration: none; font-size: 13px;">â†’ Latest
                        Blocks (/api/blocks)</a>
                    <a href="/api/transfers" style="color: #667eea; text-decoration: none; font-size: 13px;">â†’ Latest
                        Transfers (/api/transfers)</a>
                </div>
                <button class="action-btn" onclick="location.href='/api/admin/start-demo'">ğŸ® Start Demo Mode</button>
            </div>
        </div>

        <!-- Grafana Dashboard Integration -->
        <div class="card">
            <h2>ğŸ“ˆ Real-time Grafana Dashboard</h2>
            <p style="color: #666; font-size: 13px; margin-bottom: 15px;">Live monitoring of indexer performance metrics
            </p>
            <div
                style="border: 1px solid #222; border-radius: 12px; overflow: hidden; background: #000; height: 600px;">
                <iframe
                    id="grafana-iframe"
                    src=""
                    width="100%" height="100%" frameborder="0" style="background: #121212">
                </iframe>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“¦ Latest Blocks</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Block #</th>
                        <th>Hash</th>
                        <th>Parent Hash</th>
                        <th>Status / Time</th>
                    </tr>
                </thead>
                <tbody id="blocksTable">
                    <tr>
                        <td colspan="4" class="loading">Waiting for sync...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="card">
            <h2>ğŸ’¸ Latest Transfers</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Block</th>
                        <th>Type</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Amount</th>
                        <th>Token</th>
                    </tr>
                </thead>
                <tbody id="transfersTable">
                    <tr>
                        <td colspan="6" class="loading">No transactions found...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <script src="/static/dashboard.js?v=20260217v3"></script>
    <link rel="stylesheet" href="/static/dashboard.css?v=20260217v3">
</body>

</html>