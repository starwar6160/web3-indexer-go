#!/bin/bash
# ğŸ›¡ï¸ Nil Pointer é˜²å¾¡æ€§ä¿®å¤éªŒè¯è„šæœ¬ï¼ˆæœ€ç»ˆç‰ˆï¼‰

echo "=== ğŸ›¡ï¸ ä¸‰å±‚é˜²å¾¡ä¿®å¤éªŒè¯ ==="
echo ""

# 1. ç¼–è¯‘éªŒè¯
echo "1ï¸âƒ£ ç¼–è¯‘éªŒè¯..."
if go build -o /tmp/web3-indexer-fixed ./cmd/indexer 2>&1; then
    echo "âœ… ç¼–è¯‘æˆåŠŸ"
else
    echo "âŒ ç¼–è¯‘å¤±è´¥"
    exit 1
fi
echo ""

# 2. ä¸‰å±‚é˜²å¾¡æ¸…å•ç¡®è®¤
echo "2ï¸âƒ£ ä¸‰å±‚é˜²å¾¡æ¸…å•ç¡®è®¤..."
echo ""
echo "âœ… Layer 1: Processor Batch é˜²å¾¡"
echo "   - æ–‡ä»¶: internal/engine/processor_batch.go:145-161"
echo "   - ä¿®å¤: åå‘æŸ¥æ‰¾ lastValidBlock"
echo "   - æ•ˆæœ: é¿å… nil pointer dereference"
echo ""
echo "âœ… Layer 2: Fetcher å±‚è¿‡æ»¤"
echo "   - æ–‡ä»¶: internal/engine/fetcher_block.go:72-78, 102-107"
echo "   - ä¿®å¤: 2 å¤„ header nil æ£€æŸ¥"
echo "   - æ•ˆæœ: é˜²æ­¢ nil BlockData è¿›å…¥é˜Ÿåˆ—"
echo ""
echo "âœ… Layer 3: Sequencer è‡ªæ„ˆ"
echo "   - æ–‡ä»¶: cmd/indexer/main.go:104-130 (å‡½æ•°), 280 (è°ƒç”¨)"
echo "   - ä¿®å¤: ç‹¬ç«‹è‡ªæ„ˆå‡½æ•° + 3 ç§’é‡å¯"
echo "   - æ•ˆæœ: Panic åè‡ªåŠ¨æ¢å¤"
echo ""

# 3. ç«‹å³åŠ¨ä½œå»ºè®®
echo "3ï¸âƒ£ ç«‹å³åŠ¨ä½œï¼ˆä¿®å¤åï¼‰..."
echo ""
echo "1ï¸âƒ£  æ¸…ç†åƒµå°¸è¿›ç¨‹:"
echo "   lsof -ti:8092 | xargs kill -9"
echo ""
echo "2ï¸âƒ£ é‡å¯æ•°æ®åº“ï¼ˆé‡Šæ”¾å¯èƒ½çš„æ­»é”ï¼‰:"
echo "   docker restart web3-indexer-db"
echo ""
echo "3ï¸âƒ£ æ¸…ç†å¯èƒ½çš„å­¤å„¿äº‹åŠ¡:"
echo "   PGPASSWORD=W3b3_Idx_Secur3_2026_Sec psql -h 127.0.0.1 -p 15432 -U postgres -d web3_demo \\"
echo "     -c \"VACUUM FULL ANALYZE;\""
echo ""
echo "4ï¸âƒ£ é‡æ–°å¯åŠ¨ Indexerï¼ˆå¸¦è‡ªæ„ˆæœºåˆ¶ï¼‰:"
echo "   make test-a2"
echo ""
echo "5ï¸âƒ£ è§‚å¯Ÿæ—¥å¿—ï¼ˆåº”è¯¥çœ‹åˆ°ï¼‰:"
echo "   ğŸ”„ [SELF-HEAL] Starting Sequencer..."
echo "   âš ï¸ [FETCHER] Received nil header for block with logs (å¶å°”ï¼Œæ­£å¸¸)"
echo "   âš ï¸ [BATCH] No valid blocks found in batch (æç«¯æƒ…å†µ)"
echo ""

# 4. ç›‘æ§å‘½ä»¤
echo "4ï¸âƒ£ æŒç»­ç›‘æ§å‘½ä»¤..."
echo ""
echo "# æŸ¥çœ‹ Sequencer è‡ªæ„ˆå¯åŠ¨æ—¥å¿—"
echo "grep 'SELF-HEAL.*Starting Sequencer' /tmp/anvil-pro-lab.log"
echo ""
echo "# æŸ¥çœ‹ Sequencer é‡å¯æ¬¡æ•°ï¼ˆå¦‚æœ panicï¼‰"
echo "grep 'SELF-HEAL.*crashed' /tmp/anvil-pro-lab.log | wc -l"
echo ""
echo "# æŸ¥çœ‹ nil header è¿‡æ»¤æ¬¡æ•°"
echo "grep 'nil header' /tmp/anvil-pro-lab.log | wc -l"
echo ""
echo "# æŸ¥çœ‹ panic æ¬¡æ•°"
echo "grep 'named_panic_recovered' /tmp/anvil-pro-lab.log | wc -l"
echo ""

# 5. å…³é”®æŒ‡æ ‡
echo "5ï¸âƒ£ å…³é”®æŒ‡æ ‡..."
echo ""
echo "âœ… æ­£å¸¸è¿è¡Œ:"
echo "   - Sequencer è‡ªæ„ˆå¯åŠ¨: 1 æ¬¡"
echo "   - Sequencer å´©æºƒé‡å¯: 0 æ¬¡"
echo "   - nil header: < 5 æ¬¡/å°æ—¶"
echo "   - panic: 0 æ¬¡"
echo "   - Sync Lag: æŒç»­é™ä½"
echo ""
echo "âš ï¸  å¼‚å¸¸ä¿¡å·:"
echo "   - Sequencer é¢‘ç¹é‡å¯ (>1æ¬¡/åˆ†é’Ÿ)"
echo "   - å¤§é‡ nil block (>10æ¬¡/åˆ†é’Ÿ)"
echo "   - Sync Lag æŒç»­å¢é•¿"
echo ""

# 6. é¢„æœŸæ•ˆæœ
echo "6ï¸âƒ£ é¢„æœŸæ•ˆæœ..."
echo ""
echo "ğŸ¯ ä¸‰å±‚é˜²å¾¡ä½“ç³»:"
echo "   - Layer 1: Processor å±‚æ‹¦æˆª nil blockï¼ˆæœ€åä¸€é“é˜²çº¿ï¼‰"
echo "   - Layer 2: Fetcher å±‚è¿‡æ»¤ nil headerï¼ˆç¬¬ä¸€é“é˜²çº¿ï¼‰"
echo "   - Layer 3: Sequencer è‡ªæ„ˆé‡å¯ï¼ˆç³»ç»Ÿçº§ä¿æŠ¤ï¼‰"
echo ""
echo "ğŸ“Š æ”¹å–„é¢„æœŸ:"
echo "   - Panic æ¬¡æ•°: ä» >0 æ¬¡/å°æ—¶ â†’ 0 æ¬¡"
echo "   - ç³»ç»Ÿå¯ç”¨æ€§: ä» åƒµå°¸çŠ¶æ€ â†’ è‡ªåŠ¨æ¢å¤"
echo "   - æŒä¹…æ€§: è¿½æ±‚ 6 ä¸ª 9 (99.9999%)"
echo ""

echo "=== âœ… ä¿®å¤éªŒè¯å®Œæˆ ==="
echo ""
echo "ğŸ’¡ ä¸‹ä¸€æ­¥:"
echo "   1. æ‰§è¡Œä¸Šè¿°ç«‹å³åŠ¨ä½œ"
echo "   2. è§‚å¯Ÿ /tmp/anvil-pro-lab.log"
echo "   3. éªŒè¯è‡ªæ„ˆæœºåˆ¶æ˜¯å¦ç”Ÿæ•ˆ"
echo "   4. ç›‘æ§ Sync Lag æ˜¯å¦æŒç»­é™ä½"
echo ""
echo "ğŸ¯ ç›®æ ‡:"
echo "   - âœ… nil pointer å…ç–«ï¼ˆä¸‰å±‚é˜²å¾¡ï¼‰"
echo "   - âœ… panic åè‡ªæ„ˆï¼ˆ3 ç§’é‡å¯ï¼‰"
echo "   - âœ… ç³»ç»Ÿç¨³å®šæ€§æå‡ï¼ˆ6 ä¸ª 9 æŒä¹…æ€§ï¼‰"
