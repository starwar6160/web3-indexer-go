#!/bin/bash
# ğŸ›¡ï¸ Web3 Indexer - Vulnerability Scanning
# Automated security vulnerability scanning using Trivy

set -e

PROJECT_DIR="/home/ubuntu/zwCode/web3-indexer-go"
LOG_FILE="$PROJECT_DIR/logs/vulnerability-scan.log"
TRIVY_BIN="$HOME/go/bin/trivy"

# Create log directory if not exists
mkdir -p "$(dirname "$LOG_FILE")"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

error() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] âŒ ERROR: $1" | tee -a "$LOG_FILE" >&2
    exit 1
}

# Check if trivy is installed
if [ ! -f "$TRIVY_BIN" ]; then
    error "Trivy not found at $TRIVY_BIN. Install with: wget -qO- https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -"
fi

log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
log "ğŸ” Starting vulnerability scan..."
log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Update vulnerability database
log "ğŸ“¥ Updating vulnerability database..."
$TRIVY_BIN image --download-db-only > /dev/null 2>&1

# Scan for HIGH and CRITICAL vulnerabilities
log "ğŸ” Scanning for HIGH and CRITICAL vulnerabilities..."
SCAN_RESULT=$($TRIVY_BIN fs \
    --scanners vuln \
    --severity HIGH,CRITICAL \
    --format json \
    "$PROJECT_DIR" 2>/dev/null)

# Parse results - check Results array for actual vulnerabilities
VULN_COUNT=$(echo "$SCAN_RESULT" | jq -r '[.Results[]? | .Vulnerabilities // [] | length] | add' 2>/dev/null || echo "0")

if [ "$VULN_COUNT" -gt 0 ]; then
    log "ğŸš¨ CRITICAL: Found $VULN_COUNT vulnerabilities!"

    # Show detailed results
    echo "$SCAN_RESULT" | jq -r '.Results[]? | select(.Vulnerabilities != null) | "\(.Target): \(.Vulnerabilities | length) vulnerabilities"' | while read -r line; do
        log "âš ï¸  $line"
    done

    log ""
    log "ğŸ”§ Run 'trivy fs --severity HIGH,CRITICAL .' for details"
    log "ğŸ”§ Fix vulnerabilities with 'go get -u package@version'"
    exit 1
else
    log "âœ… No HIGH or CRITICAL vulnerabilities found!"
fi

# Check for MEDIUM vulnerabilities (informational)
log "ğŸ” Scanning for MEDIUM vulnerabilities (informational)..."
MEDIUM_RESULT=$($TRIVY_BIN fs \
    --scanners vuln \
    --severity MEDIUM \
    --format table \
    "$PROJECT_DIR" 2>/dev/null | grep -A 5 "Total:" || echo "")

if [ -n "$MEDIUM_RESULT" ]; then
    log "ğŸ“Š MEDIUM severity vulnerabilities found:"
    echo "$MEDIUM_RESULT" | tee -a "$LOG_FILE"
else
    log "âœ… No MEDIUM severity vulnerabilities found!"
fi

# License check (informational)
log "ğŸ“œ Checking license compliance..."
LICENSE_RESULT=$($TRIVY_BIN fs \
    --scanners license \
    --format table \
    "$PROJECT_DIR" 2>/dev/null | grep -A 10 "license" || echo "")

if [ -n "$LICENSE_RESULT" ]; then
    log "ğŸ“‹ License Summary:"
    echo "$LICENSE_RESULT" | tee -a "$LOG_FILE"
fi

log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
log "ğŸ‰ Vulnerability scan completed successfully!"
log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
log ""
log "ğŸ“Š Summary:"
log "  â€¢ HIGH/CRITICAL vulnerabilities: 0"
log "  â€¢ Scan duration: $(date '+%Y-%m-%d %H:%M:%S')"
log "  â€¢ Trivy version: $($TRIVY_BIN --version | head -1)"
log ""

exit 0
