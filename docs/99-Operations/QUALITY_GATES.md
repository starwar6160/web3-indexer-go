# ğŸ›¡ï¸ Web3 Indexer - Production-Grade Quality Assurance

æœ¬æ–‡æ¡£æè¿°äº†é¡¹ç›®é‡‡ç”¨çš„å¤šå±‚æ¬¡ä»£ç è´¨é‡ä¿éšœä½“ç³»ï¼Œæ—¨åœ¨è¾¾åˆ° **6 ä¸ª 9 çš„æŒä¹…æ€§**æ ‡å‡†ã€‚

---

## ğŸ“‹ ç›®å½•

- [è‡ªåŠ¨åŒ–è´¨é‡é—¸é—¨](#è‡ªåŠ¨åŒ–è´¨é‡é—¸é—¨)
- [æœ¬åœ°å¼€å‘å·¥ä½œæµ](#æœ¬åœ°å¼€å‘å·¥ä½œæµ)
- [CI/CD æµæ°´çº¿](#cicd-æµæ°´çº¿)
- [è´¨é‡æŒ‡æ ‡](#è´¨é‡æŒ‡æ ‡)
- [Web3 ä¸“é¡¹å®¡æŸ¥](#web3-ä¸“é¡¹å®¡æŸ¥)

---

## ğŸš¦ è‡ªåŠ¨åŒ–è´¨é‡é—¸é—¨

æ‰€æœ‰ä»£ç åˆå…¥ä¸»åˆ†æ”¯å‰å¿…é¡»é€šè¿‡ä»¥ä¸‹è´¨é‡é—¸é—¨ï¼š

### 1. é™æ€ä»£ç åˆ†æ (golangci-lint)

```bash
make lint
```

**æ£€æŸ¥é¡¹ï¼š**
- âœ… ä»£ç æ ¼å¼åŒ– (`gofmt`)
- âœ… é™æ€é”™è¯¯æ£€æµ‹ (`govet`)
- âœ… æ‰€æœ‰é”™è¯¯å¿…é¡»æ£€æŸ¥ (`errcheck`)
- âœ… HTTP/RPC Body å¿…é¡»å…³é—­ (`bodyclose`)
- âœ… SQL è¿æ¥å¿…é¡»å…³é—­ (`sqlclosecheck`)
- âœ… å‡½æ•°å¤æ‚åº¦ â‰¤ 15 (`gocyclo`)
- âœ… å®‰å…¨æ¼æ´æ‰«æ (`gosec`)

**é…ç½®æ–‡ä»¶ï¼š** `.golangci.yml`

### 2. å®‰å…¨æ¼æ´æ‰«æ

```bash
make security
```

**æ£€æŸ¥é¡¹ï¼š**
- ğŸ”’ ç¡¬ç¼–ç å¯†é’¥æ£€æµ‹
- ğŸ”’ SQL æ³¨å…¥é£é™©
- ğŸ”’ ä¾èµ–åŒ…å·²çŸ¥æ¼æ´ (`govulncheck`)
- ğŸ”’ å¸¸è§ Web3 å®‰å…¨é—®é¢˜

### 3. å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯•

```bash
make test
```

**ç‰¹ç‚¹ï¼š**
- ğŸ‹ Docker é¡¹ç›®éš”ç¦»ï¼ˆä¸æ±¡æŸ“å¼€å‘ç¯å¢ƒï¼‰
- âš¡ `pg_isready` å¥åº·æ£€æŸ¥
- ğŸ§¹ è‡ªåŠ¨æ¸…ç†æµ‹è¯•ç¯å¢ƒ
- ğŸ“Š ä»£ç è¦†ç›–ç‡ç»Ÿè®¡

### 4. æ„å»ºéªŒè¯

```bash
make build
```

**éªŒè¯é¡¹ï¼š**
- âœ… `go vet` æ£€æŸ¥é€šè¿‡
- âœ… æ‰€æœ‰åŒ…å¯ç¼–è¯‘
- âœ… äºŒè¿›åˆ¶æ–‡ä»¶ç”Ÿæˆ

---

## ğŸ’» æœ¬åœ°å¼€å‘å·¥ä½œæµ

### æäº¤å‰æ£€æŸ¥

åœ¨æ¨é€ä»£ç å‰ï¼Œå»ºè®®è¿è¡Œå®Œæ•´æ£€æŸ¥ï¼š

```bash
make check
```

è¿™å°†ä¾æ¬¡æ‰§è¡Œï¼š
1. `make lint` - ä»£ç è´¨é‡æ£€æŸ¥
2. `make security` - å®‰å…¨æ¼æ´æ‰«æ
3. `make test` - å®Œæ•´æµ‹è¯•å¥—ä»¶

### å¿«é€Ÿè¿­ä»£

å¼€å‘è¿‡ç¨‹ä¸­å¯ä»¥ä½¿ç”¨å¿«é€Ÿæµ‹è¯•ï¼š

```bash
make test-quick
```

âš ï¸ **æ³¨æ„ï¼š** `test-quick` å¤ç”¨å¼€å‘æ•°æ®åº“ï¼Œä¸é€‚åˆæ­£å¼æäº¤å‰éªŒè¯ã€‚

---

## ğŸ”„ CI/CD æµæ°´çº¿

### GitHub Actions å·¥ä½œæµ

æ–‡ä»¶ï¼š`.github/workflows/ci.yml`

**æ‰§è¡Œæµç¨‹ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Push / PR      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚ Static   â”‚  golangci-lint
    â”‚ Analysis â”‚  (2-3 min)
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚ Security  â”‚  gosec + govulncheck
    â”‚ Scan      â”‚  (1-2 min)
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚ Unit      â”‚  Unit tests
    â”‚ Tests     â”‚  (1-2 min)
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Integration   â”‚  Full stack tests
    â”‚ Tests         â”‚  (2-3 min)
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Build         â”‚  vet + build
    â”‚ Verification  â”‚  (30 sec)
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Docker        â”‚  Trivy scan
    â”‚ Security      â”‚  (1-2 min)
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚ Quality   â”‚  Aggregate status
    â”‚ Report    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ€»è€—æ—¶ï¼š** ~8-12 åˆ†é’Ÿï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰

**è´¨é‡é—¨ç¦ï¼š**
- âŒ ä»»ä½• Job å¤±è´¥ â†’ PR æ— æ³•åˆå¹¶
- âœ… å…¨éƒ¨é€šè¿‡ â†’ è‡ªåŠ¨åˆå¹¶ï¼ˆéœ€ç¬¦åˆåˆ†æ”¯ä¿æŠ¤è§„åˆ™ï¼‰

---

## ğŸ“Š è´¨é‡æŒ‡æ ‡

### ç›®æ ‡æŒ‡æ ‡

| æŒ‡æ ‡ | å½“å‰ç›®æ ‡ | ç†æƒ³çŠ¶æ€ |
|------|---------|---------|
| **ä»£ç è¦†ç›–ç‡** | â‰¥ 70% | â‰¥ 85% |
| **Linter é€šè¿‡ç‡** | 100% | 100% |
| **å®‰å…¨æ¼æ´** | 0 HIGH/CRITICAL | 0 |
| **æµ‹è¯•é€šè¿‡ç‡** | 100% | 100% |
| **Cyclomatic å¤æ‚åº¦** | â‰¤ 15 | â‰¤ 10 |
| **å‡½æ•°é•¿åº¦** | â‰¤ 50 è¡Œ | â‰¤ 30 è¡Œ |

### æŸ¥çœ‹è¦†ç›–ç‡æŠ¥å‘Š

```bash
# ç”Ÿæˆè¦†ç›–ç‡
go test -coverprofile=coverage.out ./internal/engine/...
go tool cover -html=coverage.out -o coverage.html

# æŸ¥çœ‹ HTML æŠ¥å‘Š
open coverage.html
```

---

## ğŸ” Web3 ä¸“é¡¹å®¡æŸ¥

é™¤äº†è‡ªåŠ¨åŒ–å·¥å…·ï¼Œæ‰€æœ‰æ¶‰åŠåŒºå—é“¾é€»è¾‘çš„ä»£ç éœ€äººå·¥å®¡æŸ¥ï¼š

### å…³é”®æ£€æŸ¥ç‚¹

#### 1. **å¹‚ç­‰æ€§ (Idempotency)**
```go
// âœ… å¥½çš„åšæ³•
func (p *Processor) ProcessBlock(block *types.Block) error {
    tx, _ := p.db.Begin()
    defer tx.Rollback()

    // æ£€æŸ¥åŒºå—æ˜¯å¦å·²å¤„ç†
    exists, _ := p.blockExists(tx, block.Number())
    if exists {
        return nil // å¹‚ç­‰ï¼šé‡å¤åŒºå—ä¸ä¼šé‡å¤å¤„ç†
    }

    // ... å¤„ç†é€»è¾‘

    return tx.Commit()
}
```

#### 2. **é‡ç»„å¤„ç† (Reorg Safety)**
```go
// âœ… å¥½çš„åšæ³•
func (r *Reconciler) handleReorg(newBlock *types.Block) error {
    // 1. æ‰¾åˆ°åˆ†å‰ç‚¹
    forkBlock := r.findForkBlock(newBlock)
    // 2. å›æ»šåˆ°åˆ†å‰ç‚¹ï¼ˆçº§è”åˆ é™¤æ‰€æœ‰å…³è”æ•°æ®ï¼‰
    // 3. ä»åˆ†å‰ç‚¹é‡æ–°ç´¢å¼•
}
```

#### 3. **BigInt ç²¾åº¦**
```go
// âœ… å¥½çš„åšæ³•
amount := new(big.Int).SetBytes(balanceData)
formatted := amount.String() // ä¸ä½¿ç”¨ float64
```

#### 4. **å¹¶å‘ç«æ€**
```go
// âœ… å¥½çš„åšæ³•
func (s *Sequencer) enqueueTask(task Task) {
    s.mu.Lock()
    defer s.mu.Unlock()
    // ... ä»»åŠ¡é˜Ÿåˆ—æ“ä½œ
}
```

---

## ğŸ¯ é¢è¯•å±•ç¤ºå»ºè®®

### æ–¹å¼ 1ï¼šå±•ç¤º GitHub Actions è¿è¡Œè®°å½•

```
"ä½ çœ‹ï¼Œè¿™æ˜¯æˆ‘çš„ CI æµæ°´çº¿ã€‚æ‰€æœ‰ä»£ç åœ¨åˆå…¥å‰å¿…é¡»é€šè¿‡ï¼š
- 20+ é¡¹é™æ€æ£€æŸ¥
- å®‰å…¨æ¼æ´æ‰«æ
- å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯•
- Docker é•œåƒå®‰å…¨æ‰«æ

æˆ‘ä¸ç›¸ä¿¡'ç»éªŒç›´è§‰'ï¼Œæˆ‘ç›¸ä¿¡è‡ªåŠ¨åŒ–æµç¨‹ã€‚"
```

### æ–¹å¼ 2ï¼šå±•ç¤ºæœ¬åœ°å¼€å‘å·¥å…·

```bash
$ make check
ğŸ” Running golangci-lint...
âœ… Lint checks passed!
ğŸ”’ Running security scans...
âœ… Security scans completed!
ğŸ§ª Starting isolated test environment...
âœ… All tests passed!
âœ… All quality gates passed!
```

### æ–¹å¼ 3ï¼šè®²è¿°è´¨é‡ç†å¿µ

> "åœ¨ Web3 é¢†åŸŸï¼Œ'ä»£ç å³æ³•å¾‹'ã€‚ä¸€ä¸ªå¾®å°çš„é€»è¾‘æ¼æ´å¯èƒ½å¯¼è‡´èµ„äº§ä¸¢å¤±æˆ–ç´¢å¼•åç§»ã€‚æˆ‘æ„å»ºäº†è¿™å¥—åŸºäº golangci-lint å’Œ gosec çš„è‡ªåŠ¨åŒ–è´¨é‡ä¿éšœä½“ç³»ï¼Œè¿™æ˜¯æˆ‘ä½œä¸ºå·¥ç¨‹å¸ˆå¯¹ 6 ä¸ª 9 æŒä¹…æ€§çš„æ‰¿è¯ºã€‚"

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Go ä»£ç å®¡æŸ¥æ¸…å•](https://github.com/golang/go/wiki/CodeReviewComments)
- [golangci-lint æ–‡æ¡£](https://golangci-lint.run/)
- [OWASP Go å®‰å…¨æŒ‡å—](https://owasp.org/www-project-go-secure-coding-practices/)
- [Web3 æ™ºèƒ½åˆçº¦å®‰å…¨æœ€ä½³å®è·µ](https://consensys.github.io/smart-contract-best-practices/)

---

**æœ€åæ›´æ–°ï¼š** 2026-02-14
**ç»´æŠ¤è€…ï¼š** Web3 Indexer Team
